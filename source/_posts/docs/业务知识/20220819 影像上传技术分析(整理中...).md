---
title: 影像上传技术分析
date: 2022-08-19 15:09:00
cover: images/bg07.jpeg
categories:
- 总结

tags:
- work
- vuejs
- fox
---

# 影像上传技术分析



## 001影像挂载

```
<!DOCTYPE html>
<html lang="zh_CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script type="text/javascript" src="./plugins/jquery/jquery-1.11.3.js"></script>
    <script type="text/javascript" src="./plugins/pdf/pdf.min.js"></script>
    <link href="sunscan-js-main.min.css" rel="stylesheet">
    <style>
        html,
        body {
            height: 100%;
        }
    </style>
</head>

<body>
<div id="view" style="height: 100%;position: relative;bottom: 0px;left: 0px;right: 0px;top: 0px;"></div>
<script>
    var height = (window.screen.availHeight - 50 - 25 - 35 - 15) * 0.7 - 30 + "px";
    var width = Math.ceil((window.screen.availWidth) * 0.98 * 0.65) + "px";
    // 建立本地影像控件连接
    var options = {
        element: document.getElementById('view'),
        host: 'ws://127.0.0.1:17000/ws',
        height: height,
        width: width
    }
    // 连接影像平台地址信息
    var tradeXml = "<?xml version='1.0' encoding='GB2312'?><root><business appid='sunscan' tradecode='js' optiontype='0' isenc='0'><node theme='0001'><bsinf attr='BUSI_SERIAL_NO' disp='批次号' isquery='1'>20200413000002</bsinf><bsinf attr='CREATEDATE' disp='业务开始日期' isquery='1'>20210831</bsinf></node></business></root>"
    // 初始化影像目录
    var initDir = "<?xml version='1.0' encoding='GB2312'?><root><tree appid='sunscan' tradecode='js' theme='0001'><node name='IMAGE' desc='影像' isimage='1' barcode='' forms='' attri='0' isauth='1111' issuc='0'></node></tree></root>"
    // -- 字段解析 --
    // tree 目录树总结点信息
    // appid 应用号
    // theme 目录树编号
    // node 目录树节点信息
    // name 节点key值
    // isimage 是否下挂影像 1 不允许下挂 2 允许下挂影像
    // attri 目录树上节点的属性， 0 目录层级 1 资料层级
    // barcode 条码分类值  10010 906010010457
    // forms 版面分类值 身份证
    // isauth 节点权限掩码  查询、增加、删除、替换 0 无权限 1 有权限
    // isauth='1111' 都有权限 isauth=‘0111’ 不允许查询
    // issuc 是否完备性检查
    //     var initDir =`<?xml version='1.0' encoding='GB2312'?>
    // <root>
    //    <tree appid='sunscan' tradecode='js' theme='0001'>
    //         <node name='IMAGE' desc='影像' isimage='1' barcode='' forms='' attri='0' isauth='1111' issuc='0'>
    //             <node name='10067' desc='营业执照' isimage='2' barcode='' forms='0021000001006000' attri='1' isauth='1111' issuc='0'/>
    //             <node name='10002' desc='机构信用代码证' isimage='2' barcode='' forms='0021000001005000' attri='1' isauth='1111' issuc='0'/>
    //             <node name='10048' desc='基本户开户许可证' isimage='2' barcode='' forms='0021000001002000' attri='1' isauth='1111' issuc='0'/>
    //             <node name='K005' desc='外商投资批准证书' isimage='2' barcode='' forms='0021000001003000' attri='1' isauth='1111' issuc='1'/>
    //             <node name='K003' desc='照片' isimage='2' barcode='' forms='0021000001008000' attri='1' isauth='1111' issuc='0' />
    //             <node name='OTHER' desc='其他' isimage='2' barcode='' forms='0021000001007000' attri='1' isauth='1111' issuc='0'/>
    //         </node>
    //     </tree>
    // </root>`
    // 设置工具栏
    var td0037_VIEW = "<?xml version='1.0' encoding='GB2312' ?><root><head><transcode>td0037</transcode></head><body><param>1111111111111110010000000000000000</param><param>0000000</param></body></root>"
    var td0037_EDIT = "<?xml version='1.0' encoding='GB2312' ?><root><head><transcode>td0037</transcode></head><body><param>111111111111111111111111111111111111111111111111111</param><param>1111111111111111111111111111111111111111</param><param>111111111</param></body></root>"
    // 设置控件参数
    // <param name='scanduplex'>1</param><param name='masternum'>0</param><param name='sonnum'>0</param>
    var td0010 = "<?xml version='1.0' encoding='GB2312' ?><root><head><transcode>td0010</transcode></head><body><param name='isaddshowfirst' >1</param><param name='shownails'>0</param><param name='isqryshowfirst'>1</param><param name='issourcename'>1</param></body></root>"
    // 获取影像控件安装目录
    var td0080 = "<?xml version='1.0' encoding='GB2312' ?><root><head><transcode>td0080</transcode></head></root>"
    // 清空影像控件图片
    var td0050 = "<?xml version='1.0' encoding='GB2312'?><root><head><transcode>td0050</transcode></head><body><param>1</param></body></root>"
    // 设置首张图片
    var td0033 = "<?xml version='1.0' encoding='GB2312' ?><root><head><transcode>td0033</transcode></head><body><param>0</param></body></root>"
    //刷新影像
    var td0070 = "<?xml version='1.0' encoding='GB2312' ?><root><head><transcode>td0070</transcode></head><body><param>1</param></body></root>"
    // 设置影像图片例子
    // var images = "<?xml version='1.0' encoding='GB2312' ?><root><head><transcode>td0048</transcode></head><body><param url='http://158.220.182.217:8081/SunECMDM/servlet/getFile?s/lV3bcibQiD8sffKRW+dMqpL8nzApWTnvz/WtDatAEF/vhJ8MGot1VIhGCDgFKQAt20qvLZB3M20MLUPlQH05qtYk0H7DV/+pmYS/KtdPpLVvQTeIG9N8wUhnWyNNR6W5JmxSJCKayBvTFoupbs1byHOGaokL37C2pbxOSyeoBg3OYEaMyG/CdE5kIDsVjCYgQFhakGbaMyKJ8ORHKZoYjFBnsnbj6opHkQ9drmoEqx8Yn2BzfAteO99ctMIZerWKdQCK4is7KoeiCAl9rJqzZxWL4lw6wuPfUVbK42j5lur+JirJErCqhh/gGozKtwbN9qJNtYVEQ=' fileform='IMAGE'></param></body></root>"
    var images = `<?xml version='1.0' encoding='GB2312' ?>
    <root>
        <head>
            <transcode>td0048</transcode>
        </head>
        <body>
            <param url='http://158.222.166.95:8080/dip/getFile?gFBqkAzS1PcC388pcAkODM04HtGJp/o6XVtOIaFc01jZH6PSer4DoElUQcPih69C7wuDxppWrVAvDhIIgqyAIo7FMMmn1YHkp96gVEq1TT1HOBvozhTUtOWC72J12vJwfdvB1VZ2/T1fS6qiP0Y6cufXwrp+7HuajONhqFBWT1HdBa+k1q7eV2c5jpZeexWSlIx9uVDOcrI4KWrhvWMq7XPRMbqZ/ZD7PTCR2Arm16KHuw/Q6onQCicpBWPM9QfIps3eHGFrt2kTcby6UfiGlJE0NbnxeYkD'
                fileform='10067'>D:\\SunScan\\data\\tmp\\OCR本人身份证人像面001-00001-fr.jpg</param>
            <param url='http://158.222.166.95:8080/dip/getFile?gFBqkAzS1PcC388pcAkODM04HtGJp/o6XVtOIaFc01gUcQaNXOGoSgukmSdD7FJ27wuDxppWrVB/ZLVNnQebf47FMMmn1YHkp96gVEq1TT1HOBvozhTUtOWC72J12vJwfdvB1VZ2/T1fS6qiP0Y6cufXwrp+7HuajONhqFBWT1HdBa+k1q7eV2c5jpZeexWSlIx9uVDOcrKyolPzNMFlLnPRMbqZ/ZD7PTCR2Arm16KHuw/Q6onQCicpBWPM9QfIps3eHGFrt2kTcby6UfiGlJE0NbnxeYkD'
                fileform='10002'>D:\\SunScan\\data\\tmp\\OCR本人身份证国徽面001-00002-fr.jpg</param>
            <param url='http://158.222.166.95:8080/dip/getFile?gFBqkAzS1PcC388pcAkODK2Wc+faNYYUpdLHcCjOFdv/rabsNKHnHX1JkXcycx5jY8X5rqI/f43PODYSMO9l2l6s8H0nmEHAjGi+hCq9gY89OTpMK31MxvNMiirE2Roywlh3835auI6FFWJLl4a7v+Xk/LmSRa4WWiFYaR3JEDFl+6FwNo3FqOIw4byzTBXyEPqeIi41Qac/0g5q3AdoG4cVXiU5dk0eilliJPdPV46AhF4fp2MJ5Qiac4FAmPy5MqeC3jVkeZMOLlF0Jc3o8Q=='
                fileform='10048'>D:\\SunScan\\data\\tmp\\本人联网核查照片001-00003-fr.jpg</param>
            <param url='http://158.222.166.95:8080/dip/getFile?gFBqkAzS1PcC388pcAkODM04HtGJp/o6jWsn+ReQkV5TGaDarsxOTaquCNhNFocyk1R01Ril2aE7S/xoxc9gUKwy9vfJ63rMEGlhZ9AoNmeUE7Flb6wIV55RJGT1CJLHAG2FUPYvkYhzDeRpBn5c5oYfx7LNt9WlDloSFvi9ZhNzlWhd7pvT859RkbYvK/gRvkwtC9Np9+hTB3pmpQVdK/nlOc7zlcCb/YjBOpPvBoU7mmdjpIHE9CcIBY47p/DbvOJQtUsYq36YvPwIXdxdAsP/7oYSw118'
                fileform='10048'>D:\\SunScan\\data\\tmp\\OCR代理人身份证人像面001-00004-fr.jpg</param>
            <param url='http://158.222.166.95:8080/dip/getFile?gFBqkAzS1PcC388pcAkODM04HtGJp/o6jWsn+ReQkV5TGaDarsxOTRJpk5rBfiIIk1R01Ril2aG88yd8l/qUpKwy9vfJ63rMEGlhZ9AoNmeUE7Flb6wIV55RJGT1CJLHAG2FUPYvkYhzDeRpBn5c5oYfx7LNt9WlDloSFvi9ZhNzlWhd7pvT859RkbYvK/gRvkwtC9Np9+i0uey9+hZ5fvnlOc7zlcCb/YjBOpPvBoU7mmdjpIHE9CcIBY47p/DbvOJQtUsYq36YvPwIXdxdAsP/7oYSw118'
                fileform='10048'>D:\\SunScan\\data\\tmp\\OCR代理人身份证国徽面001-00005-fr.jpg</param>
            <param url='http://158.222.166.95:8080/dip/getFile?gFBqkAzS1PcC388pcAkODPYn2btBPzrEqobu8sh08TxpKYmf6L5VqUq6zXn8241A7wuDxppWrVADUhwrv68bSY7FMMmn1YHkp96gVEq1TT1HOBvozhTUtOWC72J12vJwfdvB1VZ2/T1fS6qiP0Y6cufXwrp+7HuajONhqFBWT1HdBa+k1q7eV2c5jpZeexWSYhkcaqI1awWLQYDSL2yI9HPRMbqZ/ZD7PTCR2Arm16KHuw/Q6onQCicpBWPM9QfIps3eHGFrt2kTcby6UfiGlJE0NbnxeYkD'
                fileform='10048'>D:\\SunScan\\data\\tmp\\代理人联网核查照片001-00006-fr.jpg</param>
            <param url='http://158.222.166.95:8080/dip/getFile?gFBqkAzS1PcC388pcAkODM04HtGJp/o6TXQAXoyGzrdTGaDarsxOTaquCNhNFocyk1R01Ril2aG9rModJNDLO6wy9vfJ63rMEGlhZ9AoNmeUE7Flb6wIV55RJGT1CJLHAG2FUPYvkYhzDeRpBn5c5oYfx7LNt9WlDloSFvi9ZhNzlWhd7pvT859RkbYvK/gRvkwtC9Np9+hH3WiK+VcgwfnlOc7zlcCb/YjBOpPvBoU7mmdjpIHE9CcIBY47p/DbvOJQtUsYq36YvPwIXdxdAsP/7oYSw118'
                fileform='10048'>D:\\SunScan\\data\\tmp\\OCR转出人身份证人像面001-00007-fr.jpg</param>
            <param url='http://158.222.166.95:8080/dip/getFile?gFBqkAzS1PcC388pcAkODM04HtGJp/o6TXQAXoyGzrdTGaDarsxOTRJpk5rBfiIIk1R01Ril2aFCrij3zkI93awy9vfJ63rMEGlhZ9AoNmeUE7Flb6wIV55RJGT1CJLHAG2FUPYvkYhzDeRpBn5c5oYfx7LNt9WlDloSFvi9ZhNzlWhd7pvT859RkbYvK/gRvkwtC9Np9+gb2kVR0+1fhvnlOc7zlcCb/YjBOpPvBoU7mmdjpIHE9CcIBY47p/DbvOJQtUsYq36YvPwIXdxdAsP/7oYSw118'
                fileform='10048'>D:\\SunScan\\data\\tmp\\OCR转出人身份证国徽面001-00008-fr.jpg</param>
            <param url='http://158.222.166.95:8080/dip/getFile?gFBqkAzS1PcC388pcAkODMgNGgVrRhWEXCyFOaJ9o1ZpKYmf6L5VqUq6zXn8241A7wuDxppWrVDBrorFCLyvjY7FMMmn1YHkp96gVEq1TT1HOBvozhTUtOWC72J12vJwfdvB1VZ2/T1fS6qiP0Y6cufXwrp+7HuajONhqFBWT1HdBa+k1q7eV2c5jpZeexWSthnxAAHPri2yolPzNMFlLnPRMbqZ/ZD7PTCR2Arm16KHuw/Q6onQCicpBWPM9QfIps3eHGFrt2kTcby6UfiGlJE0NbnxeYkD'
                fileform='10048'>D:\\SunScan\\data\\tmp\\转出人联网核查照片001-00009-fr.jpg</param>
        </body>
    </root>`

    /**
     * @Description :  这个方法影像插件中会引用到，不能删，命名也不能改
     * @Date : 2021-10-13 11:23:38
     */
    function JScallbackProc(paramXml) {
        return paramXml;
    }

    /**
     * @Description : 初始化并渲染影像控件界面
     * @Date : 2021-10-13 11:15:11
     */
    function init() {
        try {
            // 新建Sunscan影像控件JS
            var initSunScan = new SunScanJS(options).CreateSunScan('sunscan', 'js');
            // 将该JS对象设置为该页面全局有效
            window.initSunScan = initSunScan;
            // 调用影像控件方法
            initSunScan.then((sunscan) => {
                // 展示影像控件
                sunscan.ShowSunScan(tradeXml, initDir).then(() => {
                    // 初始化控件工具栏
                    sunscan.CommOcxFunction(td0037_VIEW);
                    // 设置控件参数
                    sunscan.CommOcxFunction(td0010);
                })
            })
        } catch (error) {
            console.log(error);
        }
    }

    /**
     * @Description :  页面加载的时候调用init方法
     * @Date : 2021-10-13 11:23:09
     */
    window.onload = init
    /**
     * @Description :  添加当前页面全局消息监听
     * @Date : 2021-10-13 11:23:26
     */
    window.addEventListener('message', function (event) {
        console.log("eventListenter execute type: " + event.data.type);
        // 调用影像控件方法
        initSunScan.then((sunscan) => {
            // 判断当前传入的状态是否为删除
            if (event.data.type && event.data.type == "reset") {
                sunscan.CommOcxFunction(td0050).then(() => {
                    console.log("eventListenter execute reset code : td0050");
                    sunscan.ShowSunScan(tradeXml, initDir)
                })
            } else if (event.data.type && event.data.type == 'edit') {
                sunscan.ShowSunScan(tradeXml, initDir).then(() => {
                    // 初始化控件工具栏
                    sunscan.CommOcxFunction(td0037_EDIT);
                    // 设置控件参数
                    // sunscan.CommOcxFunction(td0010);
                })
            } else if (event.data.type && event.data.type == 'three') {
                let three = event.data && event.data.message || []
                if (Array.isArray(three) && three.length > 0) {
                    let threeStr = three.map((item) => {
                        return ` <node name='${item.ImageNode}' desc='${item.ChineseDesc}' isimage='2' barcode='' forms='' attri='1' isauth='1111' issuc='0'/>`
                    })
                    initDir = `<?xml version='1.0' encoding='GB2312'?>
    <root>
       <tree appid='sunscan' tradecode='js' theme='0001'>
            <node name='IMAGE' desc='影像' isimage='1' barcode='' forms='' attri='0' isauth='1111' issuc='0'>
                ${threeStr.join(' ')}
            </node>
        </tree>
    </root>`
                    sunscan.ShowSunScan(tradeXml, initDir)
                }
            } else {
                var installDir
                sunscan.CommOcxFunction(td0080).then((response) => {
                    console.log("eventListenter execute other code : td0080");
                    console.log("eventListenter execute other response : " + response.xml);
                    if (response.xml) {
                        var resultXMLDom = new DOMParser().parseFromString(response.xml, "text/xml");
                        // 获取XML渲染的第一个body标签内的内容
                        var itemsDom = resultXMLDom.getElementsByTagName('item');
                        // 将Dom的HTMLCollection转化为Array便于过滤筛选
                        var itemsArr = [].concat(itemsDom)[0]
                        for (var i = 0; i < itemsArr.length; i++) {
                            // 判断当前标签是否存在
                            if (itemsArr[i].getAttribute("name") && itemsArr[i].getAttribute("name") == "tmppath") {
                                installDir = itemsArr[i].textContent
                            }
                        }
                    }
                }).then(() => {
                    // 加载图片
                    let loadImages = event.data.message.replace(/\=\=baseDir\=\=/g, installDir)
                    console.log("eventListenter execute other code : td0048");
                    console.log(loadImages)
                    sunscan.CommOcxFunction(loadImages).then(() => {
                        console.log("eventListenter execute other code : td0033");
                        sunscan.CommOcxFunction(td0070).then(() => {
                            sunscan.CommOcxFunction(td0033)
                        })
                    })
                });
            }
        });
    })
</script>
<script type="text/javascript" src="sunscan-js-main.min.js"></script>
</body>

</html>
```